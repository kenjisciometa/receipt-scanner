# 現在の実装フロー（Subtotal/Tax/Total抽出）

## 抽出フロー

```
_extractAmountsLineByLine()
    ↓
_collectAllCandidates()
    ├─→ 1. _collectTableCandidates() [優先度: 中]
    │      └─→ _extractAmountsFromTable()
    │          ├─→ テーブル検出（構造ベース）
    │          └─→ Subtotal/Tax/Total抽出
    │          └─→ スコア: 95
    │
    ├─→ 2. _collectLineBasedCandidates() [優先度: 高]
    │      └─→ 行ごとにパターンマッチ
    │          ├─→ subtotal_label, total_label, tax_label
    │          ├─→ 明示的なキーワードマッチ
    │          └─→ スコア: 様々（80-100）
    │
    └─→ 3. _collectItemsSumCandidates() [優先度: 低]
           └─→ アイテム合計から計算
               └─→ スコア: 低（明示的マッチがある場合は除外）
    ↓
_selectBestCandidates()
    ├─→ 明示的なラベルマッチ（subtotal_label, total_label等）をチェック
    │
    ├─→ 【重要】明示的なラベルマッチがある場合
    │   └─→ テーブル抽出候補を除外
    │   └─→ 行ベース候補を優先
    │
    ├─→ 明示的なラベルマッチがない場合
    │   └─→ テーブル抽出候補も考慮
    │
    └─→ 整合性スコア + 明示的マッチボーナスで評価
        ├─→ 2つ以上の明示的マッチ: +0.20
        ├─→ 1つの明示的マッチ: +0.15
        └─→ テーブル抽出も明示的マッチとして扱われる
    ↓
最終選択: 最高スコアの組み合わせを選択
```

## 優先順位のルール

### 1. 明示的なラベルマッチがある場合
- **行ベース抽出が優先**
- テーブル抽出候補は除外される
- 例: "Subtotal: €12.58" のような明示的なラベルがある場合

### 2. 明示的なラベルマッチがない場合
- **テーブル抽出も考慮される**
- テーブル抽出のスコア（95）+ 整合性スコアで評価
- 例: テーブル形式のみで、明示的なラベルがない場合

### 3. テーブル抽出の特徴
- 構造ベース検出（言語非依存）
- 複数の金額が同じ行に並んでいることを検出
- スコア: 95（高信頼度）

## 結論

**現状の実装は、テーブルが検出されても、明示的なラベルマッチ（行ベース）がある場合は行ベース抽出を優先します。**

テーブル抽出が優先されるのは、明示的なラベルマッチがない場合のみです。

---

## シーケンスラベリングモデル（TFLite）の効果

### 精度が向上する部分

**主に改善される箇所: `_collectLineBasedCandidates()`**

1. **行ベース候補収集の精度向上**
   - 現在: パターンマッチとキーワードマッチに依存
   - ML後: 位置情報と文脈から各行のラベルを予測（B-TOTAL, I-TOTAL, B-SUBTOTAL, I-SUBTOTAL, B-TAX, I-TAXなど）
   - 効果: 明示的なキーワードがない場合でも、位置情報（下部、右側など）から検出可能

2. **複数行にまたがるエンティティの検出改善**
   - 現在: 1行単位のパターンマッチ
   - ML後: BIO形式で複数行にまたがるエンティティを正しく認識
   - 効果: 店舗名や長い説明文が複数行にまたがる場合の精度向上

3. **テーブル検出との統合精度向上**
   - 現在: テーブル検出と行ベース抽出が独立
   - ML後: 各行のラベル予測により、テーブル内の各行の役割をより正確に識別
   - 効果: テーブル構造の理解が深まり、誤検出が減少

### 期待される効果

1. **キーワード非依存の検出**
   - 明示的なキーワード（"Total", "Subtotal"など）がなくても、位置情報から検出可能
   - 例: 単に「€14.34」と書かれているだけで、位置（下部、右側）からTOTALと判断

2. **言語非依存の強化**
   - 位置情報ベースの特徴量により、既存の多言語対応がさらに強化
   - 新しい言語でも位置パターンが同じであれば対応可能

3. **OCRエラーへの耐性向上**
   - 位置情報と文脈を考慮するため、テキストの誤認識があっても位置から補正可能
   - 例: "T0tal"（Oが0に誤認識）でも位置情報からTOTALと判断

4. **レイアウトの多様性への対応**
   - 学習データに含まれる多様なレイアウトパターンを学習
   - 新しいレイアウトでも、位置パターンが類似していれば検出可能

5. **候補の質の向上**
   - より正確なラベル予測により、`_selectBestCandidates()`に渡される候補の質が向上
   - 整合性チェックの精度も向上（より正確な候補から選択するため）

### 実装上の位置づけ

```
_extractAmountsLineByLine()
    ↓
_collectAllCandidates()
    ├─→ 1. _collectTableCandidates() [改善: テーブル内の各行のラベル予測が正確に]
    │
    ├─→ 2. _collectLineBasedCandidates() [大幅改善: MLモデルでラベル予測]
    │      └─→ 【ML追加】各行の特徴量ベクトルを生成
    │      └─→ 【ML追加】TFLiteモデルで各行にラベルを予測
    │      └─→ 【ML追加】予測されたラベルから候補を生成
    │      └─→ スコア: MLモデルの信頼度に基づく（90-100）
    │
    └─→ 3. _collectItemsSumCandidates() [改善: ITEM_NAME/ITEM_PRICEの検出精度向上により、ItemSum計算の精度向上]
    ↓
_selectBestCandidates() [改善: より正確な候補から選択するため精度向上]
```

### 注意点

- **テーブル検出との併用**: MLモデルは行ベース抽出を改善するが、テーブル検出の構造ベースアプローチも併用することで、より堅牢な抽出が可能
- **フォールバック**: MLモデルの推論に失敗した場合、既存のルールベース抽出にフォールバック
- **段階的導入**: まずは行ベース抽出にMLモデルを導入し、効果を確認してからテーブル検出にも統合

