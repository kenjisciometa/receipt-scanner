# 整合性チェック機能の解説

## ログ出力の意味

### 1. `Selected total_amount: 15.6 (score: 110, line: 13)`

このログは、**候補の信頼度スコア（Candidate Score）**を示しています。

#### `score: 110` の意味

- **基本スコア**: パターンマッチングの信頼度（0-100の範囲）
  - `100`: 明示的なパターン（例: "TOTAL: €15.60"）で検出
  - `90`: Subtotalパターンで検出
  - `85`: Totalラベル（位置ボーナス含む）で検出
  - `80`: Taxパターンで検出
  - `75`: Subtotalラベルで検出
  - `70`: Taxラベルで検出

- **位置ボーナス**: レシート上の位置による追加スコア（+5〜+10）
  - Totalがレシートの下60%にある場合: +10
  - Totalがレシートの下50%にある場合: +5
  - 例: 基本スコア100 + 位置ボーナス10 = **110**

#### `line: 13` の意味

- レシートの13行目（0始まり）で検出されたことを示します
- この情報は位置関係の整合性チェックに使用されます

#### スコアの計算例

```dart
// 例: "TOTAL: €15.60" が検出された場合
基本スコア: 100 (total_pattern_0 で検出)
位置ボーナス: +10 (line 13が全体の60%より下にある)
合計スコア: 110
```

---

### 2. `Consistency score: 0.99`

このログは、**整合性スコア（Consistency Score）**を示しています。これは、選択された候補の組み合わせが会計的に整合しているかを評価したスコアです。

#### スコアの範囲

- **0.0 〜 1.0** の範囲
- **1.0に近いほど整合性が高い**ことを示します

#### スコアの計算要素

整合性スコアは以下の4つの要素から計算されます：

##### 1. 基本的な整合性チェック（50%の重み）

```dart
expectedTotal = subtotal + tax
difference = |total - expectedTotal|

if (difference <= 0.01) {
  score += 0.5;  // 完全一致（1セント以内）
} else if (difference <= 0.10) {
  score += 0.3;  // 10セント以内
} else if (difference <= 1.0) {
  score += 0.1;  // 1ユーロ以内
}
```

**例（ログの場合）**:
- Total: 15.6
- Subtotal: 12.58
- Tax: 3.02
- Expected: 12.58 + 3.02 = 15.60
- Difference: |15.6 - 15.60| = 0.00
- **スコア: +0.5** ✅

##### 2. 候補の信頼度スコア（30%の重み）

```dart
avgCandidateScore = (total.score + subtotal.score + tax.score) / 3
score += (avgCandidateScore / 100.0) * 0.3
```

**例（ログの場合）**:
- Total score: 110
- Subtotal score: 95
- Tax score: 85
- Average: (110 + 95 + 85) / 3 = 96.67
- **スコア: (96.67 / 100.0) * 0.3 = +0.29**

##### 3. 位置関係の整合性（10%の重み）

```dart
if (total.lineIndex > subtotal.lineIndex) {
  score += 0.1;  // TotalはSubtotalより下にあるべき
}
```

**例（ログの場合）**:
- Total line: 13
- Subtotal line: 11
- 13 > 11 ✅
- **スコア: +0.1**

##### 4. OCR信頼度（10%の重み）

```dart
avgConfidence = (total.confidence + subtotal.confidence + tax.confidence) / 3
score += avgConfidence * 0.1
```

**例（ログの場合）**:
- 各候補のconfidenceが1.0と仮定
- Average: 1.0
- **スコア: 1.0 * 0.1 = +0.1**

#### 合計スコアの計算

```
基本整合性: 0.5
信頼度: 0.29
位置関係: 0.1
OCR信頼度: 0.1
─────────────────
合計: 0.99
```

---

### 3. `Line-by-line extraction completed. Found amounts: {total_amount: 15.6, subtotal_amount: 12.58, tax_amount: 3.02}`

このログは、**最終的に選択された金額**を示しています。

#### 選択条件

金額は以下の条件で選択されます：

##### ステップ1: 複数候補の収集

各フィールド（Total, Subtotal, Tax）について、複数の候補を収集します：

```dart
// 例: Total候補
候補1: 15.6 (score: 110, line: 13, source: "total_pattern_0")
候補2: 15.60 (score: 85, line: 13, source: "total_label")
候補3: 15.6 (score: 80, line: 14, source: "total_pattern_1")
```

##### ステップ2: 整合性チェック

全組み合わせを評価し、整合性スコアが最も高い組み合わせを選択：

```dart
// 組み合わせ1: Total(110) + Subtotal(95) + Tax(85)
整合性スコア: 0.99 ✅

// 組み合わせ2: Total(110) + Subtotal(90) + Tax(80)
整合性スコア: 0.85

// → 組み合わせ1が選択される
```

##### ステップ3: 自動修正（必要に応じて）

整合性チェックで矛盾が検出された場合：

```dart
if (|total - (subtotal + tax)| <= 0.10) {
  // 10セント以内の誤差は自動修正
  total = subtotal + tax
}
```

##### ステップ4: 最終選択

整合性チェックで選択された候補が最終結果となります。

#### 選択の優先順位

1. **整合性スコアが最も高い組み合わせ**
2. 同じスコアの場合、**候補の信頼度スコアが高い組み合わせ**
3. それでも同じ場合、**位置関係が正しい組み合わせ**

---

## 実例: ログの解釈

```
Selected total_amount: 15.6 (score: 110, line: 13)
Selected subtotal_amount: 12.58 (score: 95, line: 11)
Selected tax_amount: 3.02 (score: 85, line: 12)
Consistency score: 0.99
Line-by-line extraction completed. Found amounts: {total_amount: 15.6, subtotal_amount: 12.58, tax_amount: 3.02}
```

### 解釈

1. **候補の信頼度**:
   - Total: 110（基本100 + 位置ボーナス10）
   - Subtotal: 95（基本90 + 位置ボーナス5）
   - Tax: 85（基本80 + 位置ボーナス5）

2. **整合性スコア: 0.99**:
   - 15.6 ≈ 12.58 + 3.02 = 15.60 ✅（完全一致）
   - 高い信頼度スコア（平均96.67）
   - 正しい位置関係（TotalがSubtotalより下）
   - 高いOCR信頼度

3. **最終選択**:
   - 整合性スコア0.99で、この組み合わせが最適と判断
   - 自動修正は不要（既に整合している）

---

## スコアの閾値

### 整合性スコアの評価

- **0.9以上**: 非常に高い整合性、信頼できる
- **0.7-0.9**: 高い整合性、通常は問題なし
- **0.6-0.7**: 中程度の整合性、要確認フラグが設定される可能性
- **0.6未満**: 低い整合性、手動確認が必要

### 候補スコアの評価

- **100以上**: 非常に信頼できる（明示的なパターン + 位置ボーナス）
- **80-99**: 信頼できる（パターンまたはラベルで検出）
- **70-79**: 中程度（ラベルで検出）
- **70未満**: 低い信頼度

---

## まとめ

- **`score: 110`**: 候補の信頼度（パターンマッチング + 位置ボーナス）
- **`Consistency score: 0.99`**: 選択された組み合わせの整合性（会計ロジックの正しさ）
- **`Found amounts`**: 整合性チェックで最適と判断された最終的な金額

この実装により、OCRの誤りや複数の候補がある場合でも、会計的に整合性の高い組み合わせを自動的に選択できるようになりました。

