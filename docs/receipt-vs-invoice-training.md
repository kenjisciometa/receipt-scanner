# レシートと領収書の混合学習について

## 目次
1. [概要](#1-概要)
2. [レシートと領収書の違い](#2-レシートと領収書の違い)
3. [混合学習の可否](#3-混合学習の可否)
4. [推奨アプローチ](#4-推奨アプローチ)
5. [実装上の注意点](#5-実装上の注意点)

---

## 1. 概要

### 1.1 質問

**小売店のレシートとBtoB向けの領収書を混ぜて学習しても大丈夫か？**

### 1.2 結論

**✅ 混ぜて学習することは可能だが、注意点がある**

**理由：**
- 基本的な情報（TOTAL, DATE, MERCHANT_NAMEなど）は共通
- 位置情報ベースの特徴量を使用しているため、レイアウトの違いに対応可能
- 多様性を増やすことで、モデルの汎用性が向上

**ただし：**
- ラベルの一貫性を保つ必要がある
- レイアウトの違いを考慮する
- 必要に応じて、別々のモデルを検討

---

## 2. レシートと領収書の違い

### 2.1 レシート（小売店向け）

**特徴：**
- **目的**: 個人向け、購入の証明
- **形式**: シンプル、コンパクト
- **情報量**: 最小限（店名、日付、金額、支払方法）
- **レイアウト**: 縦長、1列構成が多い
- **アイテム**: 簡潔なリスト（商品名と価格のみ）

**例：**
```
SUPERMARKET ABC
123 Main Street
Date: 2026-01-02

Items:
Bread €2.50
Milk 1L €1.89
Apples 1kg €3.20

Subtotal: €12.58
VAT 24%: €3.02
TOTAL: €15.60

Payment: CARD
```

### 2.2 領収書（BtoB向け）

**特徴：**
- **目的**: 法人向け、税務・会計処理
- **形式**: 詳細、構造化
- **情報量**: 豊富（請求先、請求元、税務情報、詳細な明細）
- **レイアウト**: 複雑、テーブル形式が多い
- **アイテム**: 詳細な明細（数量、単価、合計、税区分など）

**例：**
```
INVOICE #INV-2026-001
From: ABC Company Ltd.
To: XYZ Corporation
Date: 2026-01-02
Due Date: 2026-02-01

Item Description          QTY    Unit Price    Tax    Total
─────────────────────────────────────────────────────────
Consulting Services       10     150.00        24%    1,860.00
Software License          1      500.00        24%      620.00
─────────────────────────────────────────────────────────
Subtotal (excl. VAT)                             2,380.00
VAT 24%                                            571.20
─────────────────────────────────────────────────────────
TOTAL AMOUNT DUE                                 2,951.20

Payment Terms: Net 30
Bank Account: FI12 3456 7890 1234 56
```

### 2.3 共通点と相違点

**共通点：**
- ✅ 店名/会社名（MERCHANT_NAME）
- ✅ 日付（DATE）
- ✅ 合計金額（TOTAL）
- ✅ 小計（SUBTOTAL）
- ✅ 税額（TAX/VAT）
- ✅ アイテムリスト（ITEM_NAME, ITEM_PRICE）
- ✅ 通貨（CURRENCY）

**相違点：**
- ❌ レイアウトの複雑さ（領収書はより構造化）
- ❌ 情報の詳細度（領収書はより詳細）
- ❌ 必須項目（領収書には追加情報がある場合がある）
- ❌ フォーマット（領収書はテーブル形式が多い）

---

## 3. 混合学習の可否

### 3.1 技術的な観点

**✅ 混合学習は可能**

**理由：**

1. **位置情報ベースの特徴量**
   - 現在の実装は位置情報（x_center, y_center, is_right_side, is_bottom_areaなど）を重視
   - レイアウトの違いは位置情報の違いとして扱える
   - テキスト内容よりも位置情報が重要

2. **共通のラベルセット**
   - レシートと領収書で使用するラベルは同じ
   - TOTAL, DATE, MERCHANT_NAME, ITEM_NAME, ITEM_PRICEなど
   - ラベルの一貫性が保たれる

3. **多様性の向上**
   - 異なるレイアウトを学習することで、モデルの汎用性が向上
   - 過学習を防ぐ効果もある

### 3.2 潜在的な課題

**注意が必要な点：**

1. **レイアウトの違い**
   - 領収書はより複雑なレイアウト
   - テーブル形式が多い
   - 位置情報のパターンが異なる可能性

2. **情報の密度**
   - 領収書は情報が密集している
   - 行数が多い
   - シーケンス長が長くなる可能性

3. **ラベルの分布**
   - レシートと領収書でラベルの分布が異なる可能性
   - 例：領収書には「請求先」「請求元」などの追加ラベルがある場合がある

### 3.3 推奨される混合比率

**推奨比率：**
- **レシート**: 60-70%
- **領収書**: 30-40%

**理由：**
- レシートの方が一般的に使用頻度が高い
- 領収書は複雑だが、レシートのパターンも重要
- バランスの取れた学習データセット

---

## 4. 推奨アプローチ

### 4.1 アプローチ1: 混合学習（推奨）

**方法：**
- レシートと領収書を混ぜて学習
- ラベルの一貫性を保つ
- レイアウトの違いを考慮

**メリット：**
- ✅ 1つのモデルで両方に対応可能
- ✅ 実装がシンプル
- ✅ メンテナンスが容易

**デメリット：**
- ❌ レイアウトの違いにより、精度が若干低下する可能性
- ❌ データのバランスを取る必要がある

**適用ケース：**
- レシートと領収書の両方を処理する必要がある
- モデルサイズを小さく保ちたい
- 実装の複雑さを最小限にしたい

### 4.2 アプローチ2: 別々のモデル

**方法：**
- レシート用と領収書用で別々のモデルを学習
- 事前にレシート/領収書を識別して、適切なモデルを選択

**メリット：**
- ✅ 各モデルの精度が向上する可能性
- ✅ レイアウトの違いを考慮しやすい

**デメリット：**
- ❌ モデルサイズが2倍になる
- ❌ 実装が複雑になる（モデル選択ロジックが必要）
- ❌ メンテナンスが大変

**適用ケース：**
- レシートと領収書で精度の差が大きい
- モデルサイズを気にしない
- 各タイプに特化したモデルが必要

### 4.3 アプローチ3: ハイブリッド（将来的な拡張）

**方法：**
- ベースモデル（混合学習）を作成
- レシート用と領収書用で微調整（fine-tuning）

**メリット：**
- ✅ ベースモデルの汎用性を保つ
- ✅ 各タイプに特化した精度を向上

**デメリット：**
- ❌ 実装が複雑
- ❌ 学習時間が長くなる

**適用ケース：**
- 将来的な拡張として検討
- 現時点では推奨しない

---

## 5. 実装上の注意点

### 5.1 ラベルの一貫性

**重要なポイント：**

1. **共通ラベルの使用**
   - レシートと領収書で同じラベルセットを使用
   - TOTAL, DATE, MERCHANT_NAME, ITEM_NAME, ITEM_PRICEなど

2. **追加ラベルの扱い**
   - 領収書特有の情報（請求先、請求元など）は「OTHER」ラベルを使用
   - または、新しいラベルを追加（例：BILL_TO, BILL_FROM）

3. **ラベルの分布**
   - レシートと領収書でラベルの分布が均等になるように調整
   - 特に重要なラベル（TOTAL, DATE）は多めに含める

### 5.2 データの前処理

**シーケンス長の正規化：**

```python
# レシート: 10-30行
# 領収書: 20-50行

# シーケンス長を統一（例：50行）
# 短いシーケンスはパディング、長いシーケンスはトリミング
max_sequence_length = 50
```

**位置情報の正規化：**

```python
# 位置情報を0-1の範囲に正規化
# レイアウトの違いを吸収
x_center = bbox[0] / image_width
y_center = bbox[1] / image_height
```

### 5.3 品質管理

**データの品質チェック：**

1. **整合性の確認**
   - `total == subtotal + tax` が維持されているか
   - レシートと領収書の両方で確認

2. **ラベルの妥当性**
   - 重要なフィールド（TOTAL, DATE）が欠落していないか
   - ラベルの分布が適切か

3. **レイアウトの多様性**
   - レシートと領収書の両方から多様なレイアウトを含める
   - テーブル形式と非テーブル形式の両方を含める

### 5.4 学習時の設定

**推奨設定：**

```python
# 1. データのバランス
receipt_ratio = 0.65  # レシート65%
invoice_ratio = 0.35  # 領収書35%

# 2. シーケンス長
max_sequence_length = 50  # 両方に対応できる長さ

# 3. バッチサイズ
batch_size = 32  # レイアウトの違いを考慮して少し大きめ

# 4. 学習率
learning_rate = 0.001  # 標準的な学習率
```

---

## 6. 実装例

### 6.1 データローダーの拡張

```python
def load_mixed_training_data(
    receipt_dir: str,
    invoice_dir: str,
    receipt_ratio: float = 0.65
) -> Tuple[np.ndarray, np.ndarray]:
    """レシートと領収書の混合データを読み込む"""
    
    # レシートデータを読み込む
    receipt_files = list(Path(receipt_dir).glob('*.json'))
    receipt_data = [load_json(f) for f in receipt_files]
    
    # 領収書データを読み込む
    invoice_files = list(Path(invoice_dir).glob('*.json'))
    invoice_data = [load_json(f) for f in invoice_files]
    
    # 比率に基づいてサンプリング
    total_samples = len(receipt_data) + len(invoice_data)
    num_receipts = int(total_samples * receipt_ratio)
    num_invoices = total_samples - num_receipts
    
    # サンプリング
    sampled_receipts = random.sample(receipt_data, min(num_receipts, len(receipt_data)))
    sampled_invoices = random.sample(invoice_data, min(num_invoices, len(invoice_data)))
    
    # 混合
    mixed_data = sampled_receipts + sampled_invoices
    random.shuffle(mixed_data)
    
    # 特徴量とラベルを抽出
    features, labels = extract_features_and_labels(mixed_data)
    
    return features, labels
```

### 6.2 メタデータの追加

```python
# レシート/領収書の識別情報をメタデータに追加
training_data = {
    'receipt_id': '...',
    'text_lines': [...],
    'metadata': {
        'document_type': 'receipt',  # または 'invoice'
        'language': 'en',
        'is_augmented': False,
    }
}
```

---

## 7. まとめ

### 7.1 推奨アプローチ

**✅ 混合学習を推奨**

**理由：**
- 基本的な情報（TOTAL, DATE, MERCHANT_NAMEなど）は共通
- 位置情報ベースの特徴量を使用しているため、レイアウトの違いに対応可能
- 1つのモデルで両方に対応可能で、実装がシンプル

### 7.2 実装のポイント

1. **データのバランス**
   - レシート: 60-70%
   - 領収書: 30-40%

2. **ラベルの一貫性**
   - 共通ラベルセットを使用
   - 追加情報は「OTHER」ラベルまたは新しいラベルを追加

3. **品質管理**
   - 整合性の確認
   - ラベルの妥当性チェック
   - レイアウトの多様性の確保

### 7.3 注意点

- **レイアウトの違い**: 位置情報のパターンが異なる可能性があるため、多様なデータを含める
- **シーケンス長**: レシートと領収書で行数が異なるため、適切な正規化が必要
- **ラベルの分布**: 各ラベルが均等に含まれるように調整

### 7.4 次のステップ

1. **ベースデータの収集**
   - レシート: 10-15件
   - 領収書: 5-10件

2. **データ拡張**
   - 各ベースデータから10-15件のバリエーションを生成

3. **学習と評価**
   - 混合データで学習
   - レシートと領収書の両方で評価

---

## 参考資料

- [ml-training-guide.md](./ml-training-guide.md)
- [pseudo-label-collection-strategy.md](./pseudo-label-collection-strategy.md)
- [Sequence_Labeling_from_textLines.md](./Sequence_Labeling_from_textLines.md)

