# Receipt Scanner Flutter App - 開発要件定義書

**プロジェクト名**: Receipt Scanner  
**バージョン**: 1.0.0  
**作成日**: 2025年1月1日  
**対象プラットフォーム**: iOS, Android  

---

## 1. プロジェクト概要

### 1.1 目的
紙やPDF形式のレシート・領収書を画像として読み込み、OCR技術によってデジタル変換し、支出管理や会計士との連携に使用できるモバイルアプリケーションを開発する。

### 1.2 主要機能
- レシート画像の撮影・取り込み
- 自動画像前処理（角度補正、明度調整、パースペクティブ補正）
- OCRによるテキスト抽出
- レシートデータの構造化（店名、日付、合計金額、税額、支払方法）
- 抽出データの確認・編集
- データのローカル保存・エクスポート

---

## 2. 対応言語・地域

### 2.1 対象言語
- **主要対象**: ヨーロッパ言語
  - フランス語 (Français)
  - ドイツ語 (Deutsch) 
  - イタリア語 (Italiano)
  - スペイン語 (Español)
  - フィンランド語 (Suomi)
  - スウェーデン語 (Svenska)

### 2.2 特殊文字対応
- 北欧特殊文字: åäöÅÄÖ (スウェーデン語)、äöÄÖ (フィンランド語)
- ラテン拡張文字: àáâãäåæçèéêëìíîï等

### 2.3 通貨・フォーマット
- 通貨: EUR (€), SEK (kr), NOK (kr), DKK (kr)
- 日付フォーマット: DD.MM.YYYY, DD/MM/YYYY, YYYY-MM-DD
- 小数点: カンマ(,)とピリオド(.)の両対応

---

## 3. 技術要件

### 3.1 必須技術スタック

#### フレームワーク・言語
- **Flutter** 3.5.0+
- **Dart** 3.5.0+

#### OCR・画像処理
- **google_mlkit_text_recognition** ^0.13.0 (メインOCRエンジン)
- **opencv_dart** ^1.0.4 (画像前処理)
- **image** ^4.1.0 (画像操作)

#### カメラ・メディア
- **image_picker** ^1.1.2 (画像取得)
- **camera** ^0.10.5 (リアルタイムカメラ)

#### データ管理
- **sqflite** ^2.3.3 (ローカルデータベース)
- **path_provider** ^2.1.4 (ファイル管理)
- **shared_preferences** ^2.3.3 (設定保存)

#### UI・UX
- **flutter_riverpod** ^2.6.1 (状態管理)
- **go_router** ^14.6.2 (ナビゲーション)
- **flutter_animate** ^4.5.0 (アニメーション)

### 3.2 プラットフォーム要件
- **iOS**: 15.5以上
- **Android**: API Level 21以上
- **アーキテクチャ**: 64bit (arm64, x86_64)

---

## 4. 機能要件

### 4.1 コア機能

#### 画像取得機能
- [REQ-001] カメラからのリアルタイム撮影
- [REQ-002] ギャラリーからの画像選択
- [REQ-003] PDF形式レシートの読み込み
- [REQ-004] 複数画像の一括処理

#### 画像前処理機能
- [REQ-005] 自動角度補正 (-45° ～ +45°)
- [REQ-006] 明度・コントラスト自動調整
- [REQ-007] パースペクティブ補正
- [REQ-008] ノイズ除去・シャープネス向上
- [REQ-009] 処理前後のプレビュー表示

#### OCR・データ抽出機能
- [REQ-010] テキスト認識（6言語対応）
- [REQ-011] 店名・商号の抽出
- [REQ-012] 購入日時の抽出・パース
- [REQ-013] 合計金額の抽出
- [REQ-014] 小計・税額の分離抽出
- [REQ-015] 支払方法の識別
- [REQ-016] 商品明細の抽出（オプション）
- [REQ-017] 信頼度スコアの算出

#### データ管理機能
- [REQ-018] 抽出データの手動編集
- [REQ-019] ローカルデータベース保存
- [REQ-020] 画像ファイルの暗号化保存
- [REQ-021] データのバックアップ・復元
- [REQ-022] CSV/JSON形式でのエクスポート

### 4.2 UI/UX機能

#### ユーザーインターフェース
- [REQ-023] 直感的なカメラ撮影UI
- [REQ-024] ドラッグ&ドロップによる画像読み込み
- [REQ-025] リアルタイム処理進捗表示
- [REQ-026] 抽出結果の分かりやすい表示
- [REQ-027] エラー状態の明確な通知

#### アクセシビリティ
- [REQ-028] 音声読み上げ対応
- [REQ-029] 高コントラストモード
- [REQ-030] フォントサイズ調整

---

## 5. 非機能要件

### 5.1 パフォーマンス要件
- **処理時間**: レシート1枚の処理を10秒以内
- **精度**: OCR認識精度 80%以上
- **メモリ使用量**: 300MB以下
- **バッテリー**: 連続1時間使用可能

### 5.2 セキュリティ要件
- 画像データのローカル暗号化
- 機密情報の外部送信禁止
- アプリ内データの自動削除機能

### 5.3 互換性要件
- 様々な解像度・アスペクト比への対応
- 古いスマートフォンでの基本動作保証
- オフライン環境での完全動作

---

## 6. 画像前処理アルゴリズム仕様

### 6.1 角度補正
```
入力: 傾いたレシート画像
処理: 
  1. Hough Line Transform でテキスト行検出
  2. 支配的な直線群の角度計算
  3. 角度 θ = arctan(slope) の算出
  4. Affine変換による回転補正
出力: 水平に補正された画像
```

### 6.2 明度・コントラスト調整
```
入力: 明度不良の画像
処理:
  1. ヒストグラム分析
  2. CLAHE (Contrast Limited Adaptive Histogram Equalization) 適用
  3. ガンマ補正 (γ = 0.8～1.2の範囲で最適化)
  4. ノイズ除去フィルター適用
出力: 明瞭なテキストが読める画像
```

### 6.3 パースペクティブ補正
```
入力: 斜めから撮影された画像
処理:
  1. Canny Edge Detection
  2. 輪郭検出でレシート境界特定
  3. 四隅座標の算出
  4. ホモグラフィ変換で正面図変換
出力: 正面から見た長方形の画像
```

---

## 7. データモデル

### 7.1 レシートデータ構造
```dart
class ReceiptData {
  String id;                    // UUID
  String imagePath;             // 元画像パス
  String processedImagePath;    // 処理済み画像パス
  String rawOcrText;           // 生OCRテキスト
  
  // 抽出データ
  String? merchantName;        // 店名
  DateTime? purchaseDate;      // 購入日時
  double? totalAmount;         // 合計金額
  double? subtotalAmount;      // 小計
  double? taxAmount;          // 税額
  String? paymentMethod;      // 支払方法
  String? currency;           // 通貨
  List<ReceiptItem>? items;   // 明細（オプション）
  
  // メタデータ
  double confidence;          // 信頼度 (0.0-1.0)
  String language;            // 検出言語
  DateTime createdAt;         // 作成日時
  DateTime? modifiedAt;       // 更新日時
  bool isVerified;            // 人的確認済み
}
```

---

## 8. 開発フェーズ

### Phase 1: 基盤構築 (1-2週間)
- プロジェクトセットアップ
- 基本UI画面作成
- カメラ機能実装

### Phase 2: 画像処理 (2-3週間)
- OpenCV統合
- 前処理アルゴリズム実装
- 品質評価機能

### Phase 3: OCR統合 (1-2週間)
- Google ML Kit統合
- 多言語テキスト抽出
- 信頼度評価

### Phase 4: データ抽出 (2-3週間)
- 正規表現パターン実装
- 各言語対応
- 構造化データ生成

### Phase 5: UI/UX完成 (1-2週間)
- 編集機能実装
- エクスポート機能
- エラーハンドリング

### Phase 6: テスト・最適化 (1-2週間)
- 各言語テストデータでの検証
- パフォーマンス最適化
- バグ修正

---

## 9. 成功指標

### 9.1 技術指標
- OCR精度: 80%以上
- 処理速度: 1枚あたり10秒以内
- クラッシュ率: 0.1%以下

### 9.2 ユーザビリティ指標
- 初回撮影成功率: 90%以上
- データ編集完了率: 95%以上
- アプリ継続利用率: 70%以上

---

## 10. リスク・制約事項

### 10.1 技術リスク
- レシートフォーマットの多様性による認識精度の低下
- 照明条件による画質劣化
- デバイス性能差によるパフォーマンス問題

### 10.2 対応策
- 多様なサンプルデータでの継続的テスト
- 段階的画質改善アルゴリズム
- 最小動作要件の明確化

---

**承認**: ________  
**日付**: 2025年1月1日