# レシート抽出：シーケンスラベリング + ルール補完による実装案

**学習データ自動生成 → TFLiteでオンデバイス推論 → Flutter統合**

---

## 1. 目的（ゴール）
スマホで撮ったレシート画像からOCRで取得した**textLines（文字列＋位置情報）**を使って、以下を安定して抽出する：

### 抽出対象
- **合計（Total）**
- **小計（Subtotal）**
- **税（Tax / VAT）**
- **税内訳（Tax breakdown：税率ごとの税額/課税対象額）**
- **日付**
- **店舗名**

### OCR誤りへの対応
OCRの数字ミス（例：8と0、1と7、,と.など）を吸収するため：

- `subtotal + tax == total` の整合性チェック
- `tax breakdown` から `tax` や `total` を再計算して矛盾検知
- 矛盾があったら **最も整合する候補に修正** or **要確認に落とす**

---

## 2. なぜシーケンスラベリング（NER風）が有効か？
レシートはフォーマットが店ごとに異なりますが、以下の共通パターンがあります：

- **金額は右側に寄りやすい**
- **Total は下の方に出やすい**
- **VAT/TAX は "VAT 10%" みたいなラベルと近い**
- **Subtotal は Total より上にあることが多い**
- **税内訳は "Rate / Base / VAT" のように列構造がある**

この「**単語そのもの**（Total, VAT, 19%…）＋ **位置**（x,y）＋ **周辺の並び**」を使って  
**各行（またはトークン）にラベルを付ける**のがシーケンスラベリングです。

NER（固有表現抽出）と同じで、例として各行にラベルを付けます：

- `B-TOTAL_LABEL` / `I-TOTAL_LABEL`
- `B-TOTAL_VALUE`
- `B-SUBTOTAL_VALUE`
- `B-TAX_VALUE`
- `B-VAT_RATE`（例：10%）
- `B-VAT_AMOUNT`（税額）
- `B-VAT_BASE`（課税対象額）
- `B-DATE`
- `B-MERCHANT`

※最初は「行単位（textLine単位）」のラベリングが簡単です。慣れたらトークン単位へ。

---

## 3. 入力データ：textLines（文字列＋位置情報）の活用方法
OCRから以下が取れる想定です：

- `text`: 行文字列（例：`TOTAL 15,60 €`）
- `bbox`: 行の矩形（left, top, right, bottom）
- `confidence`（あれば）
- 画像サイズ（W,H）

### 3.1 位置情報の正規化（重要）
レシート画像のサイズは毎回違うので、座標は **0〜1に正規化**します。

- `x_center = (left + right)/2 / W`
- `y_center = (top + bottom)/2 / H`
- `width = (right-left)/W`
- `height = (bottom-top)/H`

これで機種差や解像度差に強くなります。

### 3.2 並び順（シーケンス）の作成
基本は **上から下**に並べます。

- `y_center` でソート  
- 同じ行っぽいものは `y_center` 近い順＋ `x_center` で整列

レシートは「読書順（上→下、左→右）」が自然なので、まずこれでOKです。

---

## 4. モデル設計（2つのアプローチ）
### 4.1 案A：軽量で作りやすい（推奨）
**BiLSTM（または1D-CNN） + Softmax**（行単位ラベル）

- 入力：各行の特徴量ベクトル
- 出力：各行のラベル（TOTAL_VALUEなど）
- 長所：実装が簡単、TFLite化もしやすい
- 短所：ラベルの整合（B/I）や遷移制約は弱い

※CRF（条件付き確率場）を最後に付けると精度が上がりますが、TFLite対応がやや面倒です。最初はSoftmaxでOK。

### 4.2 案B：精度重視（中級者向け）
**Transformer（小型）**（LayoutLM風の簡易版）

- テキスト埋め込み + 座標埋め込みを混ぜる
- 長所：複雑なパターンに強い
- 短所：学習・調整コストが上がる、端末負荷も増える

初心者ならまず案Aで「動く→改善」が早いです。

---

## 5. 特徴量（features）の設計
各行（textLine）から特徴量を作ります。おすすめは「テキスト特徴＋位置特徴＋正規表現特徴」です。

### 5.1 位置特徴（数値）
- `x_center, y_center, width, height`
- `is_right_side`（x_center>0.65など）
- `is_bottom_area`（y_center>0.7など）
- `line_index_norm`（行番号/総行数）

### 5.2 テキスト特徴（簡易版）
初心者向けに「まずは軽い特徴」：
- `has_currency_symbol`（€, £, kr, EURなど）
- `has_percent`（%）
- `has_amount_like`（`12,34` / `12.34` など）
- `has_total_keyword`（total, sum, yhteensä, totale, gesamt…）
- `has_tax_keyword`（vat, iva, mwst, tva, moms, alv…）
- `has_subtotal_keyword`（subtotal, zwischensumme…）
- `has_date_like`（dd/mm/yyyyなど）
- `digit_count`, `alpha_count`
- `contains_colon`

### 5.3 埋め込み（発展版）
- 行テキストを **サブワード/文字単位**で埋め込み（小型）
- ただし初心者は「正規表現＋少量の埋め込み」から始めるのが安全です。

---

## 6. 学習データの自動生成
ここが一番の壁です。手でラベル付けすると大変なので、**ルールで擬似ラベルを作って学習**し、徐々に改善します。

### 6.1 ルールベースで擬似ラベルを生成
例：
- `TOTAL` ラベル行：`/(total|sum|yhteensä|gesamt|totale)/i` が含まれる行
- `TOTAL_VALUE`：その行にある金額っぽい値、または近い右側行の金額
- `VAT_RATE`：`/(\d{1,2}[.,]?\d?)\s*%/` を含む行
- `DATE`：日付正規表現にマッチ

これを “教師データ（擬似）” として貯めます。

### 6.2 ノイズを考慮した学習戦略
擬似ラベルは間違います。なので戦略としては：

- 擬似ラベルの信頼度スコアを付ける（例：Totalキーワード＋金額が同じ行なら高い）
- 低信頼は学習に入れない or lossの重みを下げる
- まずは「Total/Subtotal/Tax/Date」など主要項目から

### 6.3 データ拡張（Data Augmentation）
- 金額の表記ゆれ：`12.34` ↔ `12,34` ↔ `1 234,56`
- OCR誤りっぽい変換：`0↔O`, `1↔I`, `8↔B`
- 位置揺らぎ：bboxに少しノイズ
- キーワード言語ゆれ（欧州多言語）

---

## 7. ルールベース補完（整合性チェックによる最終決定）
MLは「候補を出す」のが得意、**最終決定は会計ロジックで固める**のが強いです。

### 7.1 複数候補の保持
モデル出力を「一つに決め打ち」せず、例えば：
- `TOTAL_VALUE候補` 上位3つ
- `TAX候補` 上位3つ
- `SUBTOTAL候補` 上位3つ

を保持します。

### 7.2 整合性スコアによる最終決定
例：スコア関数（ざっくり）

- `|total - (subtotal + tax)|` が小さいほど加点
- VAT breakdown があるなら  
  - `tax == sum(vat_amounts)`  
  - `subtotal == sum(vat_bases)`（店によるが有力）  
  - `total == subtotal + tax`  
- `total` はレシート下側にあるほど加点
- `total` のラベル行に `TOTAL` キーワードが近いほど加点

このスコアで、候補の組み合わせから最良を選びます（小さな探索でOK）。

### 7.3 矛盾が解決できない場合の処理
- 「要確認」フラグを立てる
- UIでユーザーが修正しやすいように候補も提示する

これがプロダクトとしてめちゃくちゃ重要です。

---

## 8. TFLiteでオンデバイス推論
### 8.1 学習環境（Python）
- PyTorch or TensorFlowで学習
- 最終的にTensorFlowへ（またはTF-Kerasで最初から作る）

初心者は **最初からTF-Kerasでモデルを作る**のがTFLite化が簡単です。

### 8.2 TFLite変換
- `SavedModel` を出力
- `tflite_convert`（またはPython API）で `.tflite` へ
- 可能なら量子化（int8 / float16）で軽量化

### 8.3 Flutterでの推論
- `tflite_flutter`（一般に使われる）などで `.tflite` をロード
- 入力テンソルに **行特徴量の配列**を詰める
- 出力：各行のラベル確率

注意：  
- 入力の行数が可変だと面倒なので、**最大行数Nを決めてpadding**します（例：N=200行）
- 超えたら下側を優先する、などルールで切る

---

## 9. 実装ステップ（推奨順序）
### 9.1 Step 1：textLines整形器の作成（Flutter側）
- OCR結果 → `List<TextLine>` に正規化
- bbox正規化、ソート、特徴量の基礎（正規表現特徴など）を作る

### 9.2 Step 2：ルールベース抽出 + 整合性チェック
- まずは既存のregex抽出を強化しつつ、
- 候補複数保持＋整合性スコアで選ぶ
- ここだけで精度が結構上がります（ML無しでも）

### 9.3 Step 3：擬似ラベルの収集（ログ保存）
- ルールで取れた結果＋OCRテキスト＋bboxを保存
- ユーザーが修正した正解も保存（可能なら最強）

### 9.4 Step 4：シーケンスラベリングモデルの学習（Python）
- 入力：行特徴量配列
- 出力：行ラベル
- 擬似ラベルで事前学習 → 手修正データで微調整

### 9.5 Step 5：TFLite化とFlutter統合
- 推論 → 候補抽出 → 整合性スコアで最終決定

---

## 10. よくある落とし穴と対策
| 問題 | 対策 |
|------|------|
| **Totalっぽい金額が複数ある**（割引前、現金支払い額、釣りなど） | "Totalキーワード＋下側＋最大金額"の優先順位 + 整合性で解く |
| **税が0のレシート**（免税・非課税） | taxが無い前提も許容する |
| **通貨がkrで国が複数**（SEK/NOK/DKK） | 文字列だけで決めず、国推定や店舗情報で補助 |
| **OCRが改行を壊す** | "近いy座標の行をマージ"など前処理が効く |

---

## 11. 最小構成のラベル設計
初心者が最初にやるなら、このラベルで十分です：

- `O`（その他）
- `TOTAL_VALUE`
- `SUBTOTAL_VALUE`
- `TAX_VALUE`
- `DATE`
- `MERCHANT`

税内訳（VAT breakdown）は次の段階で追加。

---

## 12. まとめ：この方針の強み
- ✅ ルールだけの限界（フォーマット差）を、**位置情報＋並び（シーケンス）**で超えられる  
- ✅ OCR誤りはゼロにならないが、**整合性ロジック**で"保険"がかけられる  
- ✅ 学習データは最初から完璧に作らず、**ルール→擬似ラベル→改善**で現実的に回せる  
- ✅ TFLiteでオンデバイス推論でき、EUでもプライバシー面で強い（画像/テキストを外に出さない設計が可能）

---

## 13. 次のステップ

### 実装に必要な情報
- OCRライブラリが返す `textLines` / `textBlocks` の実データ例（JSONで数件）
- 1枚のレシートで「この項目を取りたい」優先順位（まずTotal/Dateだけ、など）

### 具体化が必要な項目
必要に応じて、以下を具体化した設計書を作成：
- ディレクトリ構成
- データ形式
- 疑似ラベル生成ルール例
- TFLite入力テンソル設計
