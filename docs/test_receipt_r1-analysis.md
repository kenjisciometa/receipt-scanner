# test_receipt_r1.png 読み込み問題の分析レポート

## 問題の概要

`test_receipt_r1.png` が正しく読み込めていない。整合性スコアが0.61と低く、手動確認が必要とフラグが立っている。

## 検出された問題

### 1. Totalの誤検出

**実際のTotal:**
- Line 18: "Total Sales Incl GST 81.26" ✅ (正しい)
- Line 19: "lotal After Adj Inc! GSTi 81.20" (OCR誤り: "Total" → "lotal")

**誤検出されたTotal:**
- Line 26: "Total 79.09 2.11" ❌ (GST Summaryテーブル内のTotal)

**原因:**
- Line 26の "Total 79.09 2.11" がGST Summaryテーブル内のTotalとして検出されている
- このTotalは税額内訳テーブルの合計であり、レシート全体のTotalではない
- 位置情報（Y座標）を考慮すると、Line 18/19の方が上にあり、通常Totalは下にあるという前提と矛盾

### 2. Subtotalの誤検出

**実際のSubtotal:**
- Line 17: "Sub-total 81.20" ✅ (正しい)

**誤検出されたSubtotal:**
- Line 24: "SR @ 6% 35.09 2.11" から "35.09" ❌ (GST Summaryテーブル内のAmount)

**原因:**
- GST Summaryテーブルが検出され、その "Amount" 列の値がSubtotalとして誤解釈されている
- テーブルヘッダー "GST Summary Amount Tax" の "Amount" 列は税額計算のベース金額であり、レシート全体のSubtotalではない
- テーブル抽出ロジックが、テーブル内の値をレシート全体の値として扱っている

### 3. OCR誤認識

- "Total" → "lotal" (Line 19)
- "Incl" → "Inc!" (Line 19)
- "GST" → "GSTi" (Line 19)

これらの誤認識により、正しいTotalパターンがマッチしない。

### 4. テーブル構造の誤解釈

**検出されたテーブル:**
- ヘッダー: "GST Summary Amount Tax" (Line 23)
- データ行1: "SR @ 6% 35.09 2.11" (Line 24)
- データ行2: "ZR & 0% 44.00 0.00" (Line 25)
- 合計行: "Total 79.09 2.11" (Line 26)

**問題:**
- このテーブルは税額内訳テーブルであり、レシート全体のSubtotal/Totalではない
- テーブル抽出ロジックが、このテーブルの値をレシート全体の値として扱っている
- テーブル内の "Total" 行が、レシート全体の "Total" として誤検出されている

### 5. 整合性スコアが低い（0.61）

**検出された値:**
- Total: 79.09
- Subtotal: 35.09
- Tax: 検出されていない

**実際の値（推測）:**
- Total: 81.26 または 81.20
- Subtotal: 81.20
- Tax: 計算が必要（Total - Subtotal = 0.06 または 0.00）

**原因:**
- TotalとSubtotalが正しく検出されていないため、整合性チェックが機能していない
- Taxが検出されていないため、3つの値の整合性を確認できない

## 改善案

### 1. テーブル抽出の優先順位調整

**問題:** GST Summaryのような税額内訳テーブルが、レシート全体のSubtotal/Totalとして誤検出されている

**改善案:**
- テーブル抽出結果を候補として扱い、行ベース抽出の結果と統合して整合性チェックを行う（既に実装済み）
- テーブル抽出結果の信頼度を下げる（スコアを95から80程度に）
- テーブル抽出結果が、行ベース抽出結果と大きく異なる場合（例: 50%以上の差）、テーブル抽出結果を無視する

### 2. 位置情報による優先順位調整

**問題:** レシート全体のTotal/Subtotalが、テーブル内のTotal/Subtotalより上にある場合、位置情報による優先順位が逆転している

**改善案:**
- テーブル内のTotal/Subtotalを除外するロジックを追加
- テーブル検出時に、テーブルの境界（Y座標範囲）を記録
- 行ベース抽出時に、テーブル境界内の候補を除外またはスコアを下げる

### 3. OCR誤認識への対応

**問題:** "Total" → "lotal" のような誤認識により、正しいパターンがマッチしない

**改善案:**
- ファジーマッチングを追加（例: "lotal" → "total" として扱う）
- より柔軟なパターンマッチング（例: ".*otal.*" のようなパターン）
- OCR誤認識の一般的なパターン（"T" → "l", "I" → "!", など）を考慮した正規化

### 4. テーブル構造の理解改善

**問題:** 税額内訳テーブルとレシート全体のSubtotal/Totalを区別できていない

**改善案:**
- テーブルヘッダーを分析し、税額内訳テーブル（"GST Summary", "Tax Breakdown", など）を識別
- 税額内訳テーブルが検出された場合、そのテーブルの値をレシート全体のSubtotal/Totalとして扱わない
- テーブル内の "Total" 行を、レシート全体の "Total" として扱わない（テーブル境界内のTotalは除外）

### 5. 整合性チェックの強化

**問題:** TotalとSubtotalが正しく検出されていないため、整合性チェックが機能していない

**改善案:**
- 複数の候補を収集し、整合性チェックで最適な組み合わせを選択（既に実装済み）
- 整合性チェックで、候補の位置情報も考慮（例: SubtotalはTotalより上にあるべき）
- 整合性チェックで、OCR誤認識を考慮した柔軟なマッチング

## 推奨される実装順序

1. **テーブル境界の記録と除外ロジック** (優先度: 高)
   - テーブル検出時に、テーブルの境界（Y座標範囲）を記録
   - 行ベース抽出時に、テーブル境界内の候補を除外またはスコアを下げる

2. **OCR誤認識への対応** (優先度: 中)
   - ファジーマッチングまたは柔軟なパターンマッチングを追加

3. **テーブル構造の理解改善** (優先度: 中)
   - 税額内訳テーブルを識別し、そのテーブルの値をレシート全体のSubtotal/Totalとして扱わない

4. **整合性チェックの強化** (優先度: 低)
   - 既に実装済みだが、位置情報による優先順位調整を追加

## 期待される結果

改善後は以下の値が正しく検出されることを期待:

- **Total:** 81.26 または 81.20 (Line 18/19)
- **Subtotal:** 81.20 (Line 17)
- **Tax:** 0.06 または 0.00 (Total - Subtotal)
- **整合性スコア:** 0.9以上

